---
layout: post
title: Jekyll running on Heroku
excerpt: "Saving your Hyde by getting Jekyll running on Heroku"
categories: [tutorial, jekyll]
comments: true
image:
  feature: https://raw.githubusercontent.com/jekyll/brand/master/jekyll-logo-black-red-transparent.png
---

## Who What Why How

Like me you recently wanted to start blogging and stumbled onto Jekyll, set up you blog (or just have the default blog post) and now you need to serve this bad boy up to show the world. Then your dreams came to a screeching halt when Heroku dropped this wisdom on you:

```
remote:  !     Failed to generate site with jekyll.
remote:  !
remote:  !     Push rejected, failed to compile Ruby app.
remote:  !
remote:  !     Push failed
```

Jekyll has great documentation for deploying to GitHub pages but not so much for everywhere else. No need to fear we can slay this beast without much hassle.

## Into Jekyll to save your Hyde.

Before we get started make sure you have a current version of ruby installed and bundler installed. If not take a couple of minutes and get both of those set up. For this to work you need both of these set up.

#### Gemfile

First in the main directory lets make a file called `Gemfile` . This file will be used by bundler to install all of the necessary ruby gems. Add all of this to the file.
```
source 'https://rubygems.org'

ruby '2.2.3'

gem 'rack-contrib'
gem 'puma'
gem 'kramdown'
gem 'rouge'
gem 'jekyll'
```

Once you have this in your terminal type `bundle install`. Calling this will go and the latest versions of the gems and install them to be used for your jekyll app. This will also make a `Gemfile.lock`. DO NOT ALTER THIS FILE. This connects all of the third party gems with your app and makes them one. It has the specific details on which versions you bundles with your app.

#### Procfile

Next up we will create a `Procfile` which is used by Heroku to serve up your site.
```
web: bundle exec puma -t 5:5 -p ${PORT:-3000} -e ${RACK_ENV:-development}
```
You will notice we called puma in there and in the gem file. `Puma` will actually be serving up your static pages and is a very popular gem used to serve files on rack server environments like Heroku. Don't worry about the other variables these are standard for hosting on Heroku. ([Here is Heroku's documentation for Puma](https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server) because you shouldn't trust strangers on the internet.)

#### config.ru

Now that we have `puma` integrated with our app and have a `Procfile` to tell Heroku what to do we need to tell `puma` a little more about what to serve up and how to serve up our files. If you looked at Heroku's documentation linked a little bit ago you would have seen the next file you need is `config.ru`. Add this file to your main directory and lets dive into this one.

```ru
require 'rack'
require 'rack/contrib/try_static'

# enable compression
use Rack::Deflater

# static configuration (file path matches request path)
use Rack::TryStatic,
      :root => "_site",  # static files root dir
      :urls => %w[/],    # match all requests
      :try => ['.html', 'index.html', '/index.html'], # try these postfixes sequentially
      :gzip => true,     # enable compressed files
      :header_rules => [
        [:all, {'Cache-Control' => 'public, max-age=86400'}],
        [['css', 'js'], {'Cache-Control' => 'public, max-age=604800'}]
      ]

# otherwise 404 NotFound
notFoundPage = File.open('_site/index.html').read
run lambda { |_| [200, {'Content-Type' => 'text/html'}, [notFoundPage]]}

```
This is a lot to absorb all at once so lets break this up a little bit.

First we require two rack components and use `Rack::Deflater`. `Rack::Deflater` is used to compress your app so that you can server it up quickly and saving storage space on the server.

Next we get into the deep stuff. We call `Rack::TryStatic` to host our static pages and have a lot of parameters.

- `:root` Set the folder that has all of our static pages.
- `:urls` Matches the requests coming to your site.
- `:try` This will try all the listed values in order until it gets the right one.
- `:gzip` Used by `Rack::Deflater` to compress the app.
- `:header_rules` Manage our cache and tell `puma` how long to hold out compressed files before they have to be regenerated by the server.


The last bit of code is what happens when there is an incorrect url entered a.k.a 404 NotFound.

#### Push!

If you made it this far pat yourself on the back you are almost all set! If your git is not set up `git init` , `git add .`, `git commit -m "Just Heroku blog stuff"`. If you skipped bundling your gems earlier do it now `bundle install`. If you have a `.gitignore` make sure that your `_pages` folder is not on it! Github Pages has you ignore the file but we are actually serving the static pages.

The time has come to get this running on heroku. `heroku create` in your terminal then `git push heroku master`. Take a second to appreciate the really cool url Heroku gave you (or lame url) and then `heroku open`. There it is! Your new blog!
